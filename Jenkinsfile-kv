pipeline {
    agent any

    options {
        ansiColor('xterm')
    }

    environment {
        // Archivo secreto con configuración en formato JSON
        JOHN_SECRET = credentials('john-secret-kv') // ID de la credencial Azure Key Vault
        SECRET_JSON = credentials('john-secret-kv')
        KV_CREDENTIALS_ID = 'john-secret-kv'
    }

    stages {
        stage('Login en Azure') {
            steps {
                withCredentials([azureServicePrincipal(credentialsId: 'credentials_id')]) {
                    sh '''
                        echo "Autenticando en Azure..."
                        az login --service-principal \
                            -u "$AZURE_CLIENT_ID" \
                            -p "$AZURE_CLIENT_SECRET" \
                            --tenant "$AZURE_TENANT_ID"

                        az account set --subscription "$AZURE_SUBSCRIPTION_ID"
                    '''
                }
            }
        }

        stage('Leer secreto de Azure Key Vault') {
            steps {
                script {
                    // Leer el secreto desde Azure Key Vault
                    withCredentials([azureKeyVaultSecret(
                        credentialsId: KV_CREDENTIALS_ID,
                        secretValues: [
                            [secretValue: 'SECRET_JSON', vaultUrl: 'https://kv-func-shared-eastus.vault.azure.net', secretName: 'john-secret']
                        ]
                    )]) {
                        // El secreto está ahora disponible en la variable SECRET_JSON
                        // Parsear el JSON para acceder a los valores individuales
                        def secretData = readJSON text: SECRET_JSON

                        // Mostrar los valores del secreto
                        echo "Nombre: ${secretData.name}"
                        echo "Apellido: ${secretData.lastname}"
                        echo "Email: ${secretData.email}"
                        echo "Teléfono: ${secretData.phone}"
                        echo "Compañía: ${secretData.company}"

                        // También puedes mostrar el JSON completo si lo necesitas
                        echo "JSON completo: ${SECRET_JSON}"
                    }
                }
            }
        }
    }
}